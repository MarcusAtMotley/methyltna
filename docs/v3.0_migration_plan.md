# Pipeline v3.0 Migration Plan
## Hairpin-First Architecture with Dual Alignment Strategy

**Date Created**: October 2, 2025
**Target Version**: v3.0.0
**Current Version**: v2.0.1 (to be tagged)

---

## Executive Summary

### What's Changing
1. **Hairpin deconvolution BEFORE RNA/DNA separation** (leveraging v2 protocol capability)
2. **Dual alignment strategy**: STAR for RNA (spliced), Bowtie2 for DNA (genomic)
3. **Eliminate redundant trimming** (use methylSNP's proven trimming workflow)

### Why This Matters
- **Biological accuracy**: v2 methylSNP protocol can resolve hairpins without knowing RNA vs DNA identity
- **Computational efficiency**: Single trimming/deconvolution step instead of duplicate processing
- **Alignment optimization**: Proper aligner for each data type (splice-aware vs genomic)

---

## Current vs Proposed Architecture

### CURRENT FLOW (v2.0)
```
1. BCL_DEMULTIPLEX (optional)
2. READ_TRIMMING (FastQC → TrimGalore → FastQC)
3. TNA_DECONVOLUTION (RNA barcode extraction)
   ├── barcoded_reads (RNA)
   └── unbarcoded_reads (DNA)
4. METHYLSNP_ANALYSIS (3x: RNA, DNA, SINGLE)
   ├── METHYLSNP_TRIMREAD (redundant trimming!)
   ├── METHYLSNP_DECONVOLUTION (hairpin resolution)
   ├── STAR_ALIGN (both RNA & DNA - wrong for DNA!)
   ├── METHYLSNP_PROCESSING
   └── METHYLSNP_EXTRACTION
5. LOFREQ_VARIANT_CALLING
```

**Problems with Current Design:**
- ❌ Redundant trimming (TrimGalore + METHYLSNP_TRIMREAD)
- ❌ STAR alignment for DNA (should use Bowtie2 for genomic reads)
- ❌ Hairpin deconvolution happens 3x separately (inefficient)

### PROPOSED FLOW (v3.0)
```
1. BCL_DEMULTIPLEX (optional)
2. FastQC (pre-processing QC only - optional)
3. METHYLSNP_HAIRPIN_PROCESSING (v2 protocol)
   ├── METHYLSNP_TRIMREAD (illumina + hairpin adapters)
   └── METHYLSNP_DECONVOLUTION (hairpin resolution)
4. TNA_DECONVOLUTION (RNA barcode extraction on deconvoluted reads)
   ├── barcoded_reads (RNA)
   └── unbarcoded_reads (DNA)
5. CONDITIONAL_ALIGNMENT
   ├── RNA → STAR_ALIGN (splice-aware genome alignment)
   └── DNA → BOWTIE2_ALIGN (genomic alignment)
6. METHYLSNP_POSTPROCESSING (shared for both RNA & DNA)
   ├── METHYLSNP_PROCESSING (mark unique, duplicates, XM tags)
   └── METHYLSNP_EXTRACTION (bismark methylation extraction)
7. LOFREQ_VARIANT_CALLING (unchanged)
```

**Benefits of New Design:**
- ✅ Single trimming/deconvolution step (more efficient)
- ✅ Proper aligner for each data type
- ✅ Cleaner separation of concerns
- ✅ Maintains all existing module functionality

---

## Implementation Plan

### Phase 1: Branch & Prep (5 minutes)
**Goal**: Create safe workspace and checkpoint

#### Tasks:
1. Tag current state as checkpoint:
   ```bash
   git tag v2.0.1 -m "Checkpoint before v3.0 hairpin-first migration"
   git push origin v2.0.1
   ```

2. Create feature branch:
   ```bash
   git checkout -b feat/v3.0-hairpin-first-architecture
   ```

**Deliverables**:
- ✅ v2.0.1 tag created
- ✅ Feature branch active

---

### Phase 2: Add Bowtie2 Support (15 minutes)
**Goal**: Reinstall Bowtie2 alignment capabilities

#### Tasks:
1. Install Bowtie2 alignment module:
   ```bash
   nf-core modules install bowtie2/align
   ```

2. Install Bowtie2 index building module:
   ```bash
   nf-core modules install bowtie2/build
   ```

3. Update `subworkflows/local/prepare_references/main.nf`:
   - Add `BOWTIE2_BUILD` import
   - Build both STAR and Bowtie2 indexes in parallel
   - Emit both index channels

4. Update reference caching logic:
   - Add `references/bowtie2_indexes/genome_name/` structure
   - Support `--force_rebuild_indexes` for Bowtie2

**Deliverables**:
- ✅ Bowtie2 modules installed
- ✅ PREPARE_REFERENCES builds both index types
- ✅ Reference caching supports both aligners

---

### Phase 3: Create Hairpin Processing Subworkflow (30 minutes)
**Goal**: Extract hairpin processing into reusable subworkflow

#### Tasks:
1. Create `subworkflows/local/methylsnp_hairpin_processing/main.nf`:
   ```groovy
   include { METHYLSNP_TRIMREAD } from '../../../modules/local/methylsnp_trimread/main'
   include { METHYLSNP_DECONVOLUTION } from '../../../modules/local/methylsnp_deconvolution/main'

   workflow METHYLSNP_HAIRPIN_PROCESSING {
       take:
       input_fastqs  // channel: [meta, [fastq1, fastq2]]

       main:
       ch_versions = Channel.empty()

       METHYLSNP_TRIMREAD(input_fastqs)
       ch_versions = ch_versions.mix(METHYLSNP_TRIMREAD.out.versions)

       METHYLSNP_DECONVOLUTION(METHYLSNP_TRIMREAD.out.illumina_trimmed)
       ch_versions = ch_versions.mix(METHYLSNP_DECONVOLUTION.out.versions)

       emit:
       deconvoluted_reads  = METHYLSNP_DECONVOLUTION.out.deconvoluted_reads
       methylation_report  = METHYLSNP_DECONVOLUTION.out.methylation_report
       versions           = ch_versions
   }
   ```

2. Test subworkflow independently (if nf-test available)

**Deliverables**:
- ✅ METHYLSNP_HAIRPIN_PROCESSING subworkflow created
- ✅ Encapsulates trimming + deconvolution

---

### Phase 4: Restructure Main Workflow (45 minutes)
**Goal**: Reorganize `workflows/modulestesting.nf` with new architecture

#### Tasks:
1. Update imports section:
   ```groovy
   include { METHYLSNP_HAIRPIN_PROCESSING } from '../subworkflows/local/methylsnp_hairpin_processing/main'
   include { BOWTIE2_ALIGN } from '../modules/nf-core/bowtie2/align/main'
   include { STAR_ALIGN } from '../modules/nf-core/star/align/main'
   // Remove: METHYLSNP_ANALYSIS (will be split into components)
   ```

2. Restructure workflow logic:
   ```groovy
   // Step 1: Optional FastQC on raw reads
   if (!params.skip_fastqc) {
       FASTQC_RAW(ch_fastq_for_qc)
   }

   // Step 2: Hairpin processing (ALWAYS if methylSNP enabled)
   if (!params.skip_methylsnp_analysis) {
       METHYLSNP_HAIRPIN_PROCESSING(ch_fastq_for_qc)
       ch_processed_reads = METHYLSNP_HAIRPIN_PROCESSING.out.deconvoluted_reads
       ch_methylation_reports = METHYLSNP_HAIRPIN_PROCESSING.out.methylation_report
   }

   // Step 3: RNA barcode extraction (OPTIONAL)
   if (!params.skip_rna_deconvolution && params.rna_barcode_config) {
       TNA_DECONVOLUTION(ch_processed_reads.map { meta, reads ->
           tuple(meta, reads, cfg_file)
       })
       ch_rna_reads = TNA_DECONVOLUTION.out.barcoded_reads
       ch_dna_reads = TNA_DECONVOLUTION.out.unbarcoded_reads
   } else {
       ch_dna_reads = ch_processed_reads  // All reads treated as DNA
   }

   // Step 4: Dual alignment strategy
   if (!params.skip_rna_deconvolution && params.rna_barcode_config) {
       // RNA: STAR alignment (splice-aware)
       STAR_ALIGN(
           ch_rna_reads,
           PREPARE_REFERENCES.out.star_index,
           PREPARE_REFERENCES.out.annotation_gtf,
           false, 'ILLUMINA', ''
       )

       // DNA: Bowtie2 alignment (genomic)
       BOWTIE2_ALIGN(
           ch_dna_reads,
           PREPARE_REFERENCES.out.bowtie2_index,
           false, // save_unaligned
           false  // sort_bam
       )
   } else {
       // Single: Bowtie2 only
       BOWTIE2_ALIGN(
           ch_dna_reads,
           PREPARE_REFERENCES.out.bowtie2_index,
           false, false
       )
   }
   ```

3. Update processing/extraction to accept both STAR and Bowtie2 SAM outputs

4. Remove or simplify READ_TRIMMING subworkflow (decision point: keep FastQC-only or remove entirely)

**Deliverables**:
- ✅ Main workflow restructured
- ✅ Hairpin processing before RNA extraction
- ✅ Dual alignment implemented

---

### Phase 5: Update Configuration (20 minutes)
**Goal**: Update configs for new parameters and modules

#### Tasks:
1. Update `nextflow.config`:
   - Add Bowtie2 alignment parameters
   - Update help text/descriptions

2. Update `nextflow_schema.json`:
   - Add Bowtie2 parameter group
   - Update workflow descriptions

3. Update `conf/modules.config`:
   ```groovy
   // Bowtie2 alignment (DNA/genomic)
   withName: 'BOWTIE2_ALIGN' {
       ext.args = '--very-sensitive --dovetail --phred33'
       publishDir = [
           path: { "${params.outdir}/alignment/bowtie2" },
           mode: params.publish_dir_mode,
           saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
       ]
   }

   // STAR alignment (RNA/spliced)
   withName: 'STAR_ALIGN' {
       ext.args = '--outSAMtype SAM --outSAMunmapped Within --outSAMattributes NH HI AS nM'
       publishDir = [
           path: { "${params.outdir}/alignment/star" },
           mode: params.publish_dir_mode,
           saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
       ]
   }
   ```

4. Update `assets/multiqc_config.yml`:
   - Ensure both STAR and Bowtie2 sections present
   - Add proper sample name cleaning

**Deliverables**:
- ✅ Configuration files updated
- ✅ Parameter schema validated

---

### Phase 6: Testing & Validation (30 minutes)
**Goal**: Ensure pipeline works with new architecture

#### Tasks:
1. Run test profile:
   ```bash
   nextflow run . -profile test,docker --outdir test_v3_results
   ```

2. Validate expected outputs:
   - ✅ FastQC reports (pre-processing only)
   - ✅ Hairpin trimming logs
   - ✅ Deconvolution reports
   - ✅ RNA barcode statistics (if enabled)
   - ✅ STAR alignment logs (RNA)
   - ✅ Bowtie2 alignment logs (DNA)
   - ✅ MethylSNP processing outputs
   - ✅ Bismark extraction reports
   - ✅ LoFreq VCF files
   - ✅ MultiQC report with all sections

3. Check MultiQC report sections:
   - FastQC (raw reads)
   - RNA Barcode Statistics
   - STAR Alignment (RNA)
   - Bowtie2 Alignment (DNA)
   - Samtools (flagstat/idxstats)
   - Bismark Methylation
   - LoFreq Variants

4. Performance comparison (optional):
   - Compare runtime vs v2.0
   - Verify cache invalidation expected

**Deliverables**:
- ✅ Test run successful
- ✅ All expected outputs present
- ✅ MultiQC report validated

---

### Phase 7: Documentation & Commit (20 minutes)
**Goal**: Document changes and commit to git

#### Tasks:
1. Update `CLAUDE.md`:
   - Document v3.0 architecture
   - Update "Current Development Status" section
   - Add migration notes from v2.0 → v3.0

2. Update `README.md` (if needed):
   - Update workflow diagram
   - Update usage examples

3. Update `docs/pipeline_flowchart.md`:
   - Redraw Mermaid diagram with new architecture

4. Commit changes:
   ```bash
   git add -A
   git commit -m "feat!: v3.0 hairpin-first architecture with dual alignment

   BREAKING CHANGE: Major pipeline restructure for biological accuracy

   - Move hairpin deconvolution BEFORE RNA/DNA separation
   - Implement dual alignment: STAR for RNA, Bowtie2 for DNA
   - Eliminate redundant trimming steps
   - Maintain all existing module functionality

   Migration from v2.0:
   - Hairpin processing now occurs first (v2 protocol capability)
   - RNA reads (barcoded) → STAR splice-aware alignment
   - DNA reads (unbarcoded) → Bowtie2 genomic alignment
   - Single processing mode uses Bowtie2 only

   This is a breaking change requiring cache invalidation.

   Refs: v2.0.1 (checkpoint before migration)

   🤖 Generated with [Claude Code](https://claude.com/claude-code)

   Co-Authored-By: Claude <noreply@anthropic.com>"
   ```

5. Push to GitHub:
   ```bash
   git push -u origin feat/v3.0-hairpin-first-architecture
   ```

**Deliverables**:
- ✅ Documentation updated
- ✅ Changes committed with detailed message
- ✅ Branch pushed to remote

---

## Technical Considerations

### Module Reusability
**Unchanged Modules** (can reuse as-is):
- `METHYLSNP_TRIMREAD` ✅
- `METHYLSNP_DECONVOLUTION` ✅
- `TNA_DECONVOLUTION` (RNA barcode extraction) ✅
- `METHYLSNP_PROCESSING` ✅
- `METHYLSNP_EXTRACTION` ✅
- `LOFREQ_VARIANT_CALLING` ✅
- `MULTIQC` ✅

**Modified Workflows**:
- `workflows/modulestesting.nf` - Major restructure
- `subworkflows/local/prepare_references/main.nf` - Add Bowtie2 indexing
- `subworkflows/local/methylsnp_analysis/main.nf` - Split into components

**New Components**:
- `subworkflows/local/methylsnp_hairpin_processing/main.nf` - New subworkflow
- Bowtie2 alignment integration

### Channel Flow Changes

**Current (v2.0)**:
```
ch_samplesheet → READ_TRIMMING → TNA_DECONVOLUTION → (split)
                                                      ├── METHYLSNP_RNA → LOFREQ_RNA
                                                      └── METHYLSNP_DNA → LOFREQ_DNA
```

**Proposed (v3.0)**:
```
ch_samplesheet → METHYLSNP_HAIRPIN → TNA_DECONVOLUTION → (split)
                                                          ├── ch_rna → STAR → METHYLSNP_PROCESS → LOFREQ
                                                          └── ch_dna → BOWTIE2 → METHYLSNP_PROCESS → LOFREQ
```

### Breaking Changes
1. **Cache invalidation**: All previous work directories will be invalid
2. **Output structure**: Alignment outputs in separate `star/` and `bowtie2/` directories
3. **Parameter changes**: May need to adjust test configs
4. **Reference requirements**: Need both STAR and Bowtie2 indexes

### Risk Mitigation
- ✅ Tag v2.0.1 before starting (easy rollback)
- ✅ Use feature branch (safe experimentation)
- ✅ Preserve all existing modules (no logic rewrites)
- ✅ Comprehensive testing before merge

---

## Success Criteria

### Must Have ✅
- [ ] Pipeline runs without errors on test dataset
- [ ] MultiQC report contains all expected sections
- [ ] RNA reads use STAR alignment
- [ ] DNA reads use Bowtie2 alignment
- [ ] Hairpin processing occurs before RNA/DNA split
- [ ] All methylation outputs generated correctly
- [ ] LoFreq variant calling works for both RNA and DNA

### Nice to Have 🎯
- [ ] Performance improvement over v2.0 (fewer redundant steps)
- [ ] Comprehensive test coverage
- [ ] Updated pipeline flowchart diagram
- [ ] Migration guide for existing users

---

## Session Checkpoints

### Session 1 (Current)
- [x] Architecture analysis completed
- [x] Migration plan documented
- [ ] Phase 1: Branch & tag created
- [ ] Phase 2: Bowtie2 modules installed

### Session 2 (Next)
- [ ] Phase 3: Hairpin subworkflow created
- [ ] Phase 4: Main workflow restructured

### Session 3 (Future)
- [ ] Phase 5: Configuration updated
- [ ] Phase 6: Testing completed
- [ ] Phase 7: Documentation & commit

---

## Quick Reference

### Key Files to Modify
1. `workflows/modulestesting.nf` - Main workflow restructure
2. `subworkflows/local/prepare_references/main.nf` - Add Bowtie2 indexing
3. `subworkflows/local/methylsnp_hairpin_processing/main.nf` - NEW
4. `nextflow.config` - Bowtie2 parameters
5. `nextflow_schema.json` - Parameter schema
6. `conf/modules.config` - Module-specific configs
7. `docs/pipeline_flowchart.md` - Architecture diagram

### Commands Reference
```bash
# Setup
git tag v2.0.1 -m "Checkpoint before v3.0"
git checkout -b feat/v3.0-hairpin-first-architecture

# Module installation
nf-core modules install bowtie2/align
nf-core modules install bowtie2/build

# Testing
nextflow run . -profile test,docker --outdir test_v3_results

# Cleanup (if needed)
rm -rf work/ .nextflow* test_v3_results/
```

---

## Notes & Decisions

### Design Decisions
1. **Why hairpin first?** - v2 protocol can resolve hairpins without knowing RNA vs DNA identity
2. **Why dual alignment?** - RNA has splice junctions (needs STAR), DNA is genomic (Bowtie2 sufficient)
3. **Why eliminate TrimGalore?** - METHYLSNP_TRIMREAD already handles adapter trimming comprehensively

### Open Questions
- [ ] Keep FastQC on raw reads or remove entirely?
- [ ] Publish trimming intermediates or keep in work dir?
- [ ] Test with real production data before merging?

---

**Document Version**: 1.0
**Last Updated**: October 2, 2025
**Status**: Planning Complete - Ready for Implementation
